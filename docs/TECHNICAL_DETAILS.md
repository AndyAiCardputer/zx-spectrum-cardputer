# üî¨ ZX SPECTRUM EMULATOR - TECHNICAL DETAILS

**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞:** 24 –æ–∫—Ç—è–±—Ä—è 2025  
**–¶–µ–ª—å:** –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

---

## üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ê:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           main.cpp (ESP32)              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ   loop() - 50 FPS throttling     ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ               ‚îÇ                          ‚îÇ
‚îÇ               ‚ñº                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  ZXSpectrum::runForFrame()       ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - –ú–∞–ª—ã–µ –∫–≤–∞–Ω—Ç—ã (128 t-states)   ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - Accumulator –∫–æ–Ω—Ç—Ä–æ–ª—å          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - INT –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (50 Hz)         ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ               ‚îÇ                          ‚îÇ
‚îÇ               ‚ñº                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ     Z80Run(regs, cycles)         ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - Fetch/Decode/Execute          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - EI-delay –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ           ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - –í–æ–∑–≤—Ä–∞—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö —Ü–∏–∫–ª–æ–≤    ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ               ‚îÇ                          ‚îÇ
‚îÇ               ‚ñº                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  Memory callbacks (ROM/RAM)      ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - Z80MemRead/Write              ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - Z80InPort/OutPort             ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ‚öôÔ∏è –ö–õ–Æ–ß–ï–í–´–ï –ö–û–ú–ü–û–ù–ï–ù–¢–´:

### 1. **Z80 CPU Core** (`z80.cpp`)

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤:
```cpp
typedef struct {
  void *userInfo;              // Pointer to ZXSpectrum
  eword AF, BC, DE, HL;        // Main registers
  eword IX, IY, PC, SP, R;     // Index/Special registers
  eword AFs, BCs, DEs, HLs;    // Shadow registers
  byte IFF1, IFF2, I, halted;  // Interrupt state
  char IM;                     // Interrupt mode (0/1/2)
  byte ei_pending;             // ‚≠ê EI-delay flag
  int cycles;                  // Cycle counter
} Z80Regs;
```

#### Z80Run() –∫–æ–Ω—Ç—Ä–∞–∫—Ç:
```cpp
uint16_t Z80Run(Z80Regs *regs, int numcycles) {
  regs->cycles = numcycles;
  
  while (regs->cycles > 0) {
    // 1. Fetch opcode
    opcode = Z80ReadMem(PC++);
    
    // 2. Decode & Execute
    switch (opcode) { ... }
    
    // 3. ‚≠ê Apply EI-delay (after instruction!)
    if (regs->ei_pending) {
      regs->IFF1 = regs->IFF2 = 1;
      regs->ei_pending = 0;
    }
    
    // 4. Subtract cycles
    regs->cycles -= instruction_cycles;
  }
  
  return micValue;  // Total cycles executed
}
```

---

### 2. **EI-delay –º–µ—Ö–∞–Ω–∏–∑–º** ‚≠ê

**–ü—Ä–æ–±–ª–µ–º–∞:** Z80 CPU –∏–º–µ–µ—Ç 1-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è EI.

**–ü—Ä–∏–º–µ—Ä:**
```asm
EI      ; IFF1 –ù–ï —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É!
RET     ; –ü–æ—Å–ª–µ RET: IFF1=1
HALT    ; –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –ø—Ä–µ—Ä—ã–≤–∞—Ç—å
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

#### –í `opcodes.h`:
```cpp
case EI:
  r_ei_pending = 1;  // –ù–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º IFF1 —Å—Ä–∞–∑—É!
  AddCycles(4);
break;
```

#### –í `z80.cpp` (–∫–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞):
```cpp
// –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ö–ê–ñ–î–û–ô –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
if (regs->ei_pending) {
  regs->IFF1 = regs->IFF2 = 1;  // –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ!
  regs->ei_pending = 0;
}
```

**–ü–æ—á–µ–º—É –∫—Ä–∏—Ç–∏—á–Ω–æ:**  
–ë–µ–∑ —ç—Ç–æ–≥–æ ROM –≤—ã–ø–æ–ª–Ω—è–µ—Ç:
1. `IM 1` ‚Üí —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ä–µ–∂–∏–º –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π
2. `EI` ‚Üí —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è (IFF1=1)
3. INT –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å—Ä–∞–∑—É ‚Üí –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –¥–æ `HALT`
4. Infinite loop!

–° EI-delay:
1. `IM 1` ‚Üí –û–ö
2. `EI` ‚Üí ei_pending=1
3. `RET` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è ‚Üí IFF1=1
4. `HALT` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è ‚Üí –∂–¥—ë—Ç INT
5. INT –ø—Ä–∏—Ö–æ–¥–∏—Ç ‚Üí –û–ö!

---

### 3. **–ú–∞–ª—ã–µ –∫–≤–∞–Ω—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è** ‚≠ê

**–ü—Ä–æ–±–ª–µ–º–∞:** 
- –ü—Ä–æ—Å–∏–º 224 t-states
- –ü–æ–ª—É—á–∞–µ–º 226-230 t-states (–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –Ω–µ –¥–µ–ª—è—Ç—Å—è)
- 312 –ª–∏–Ω–∏–π √ó 2-6 "–ª–∏—à–Ω–∏—Ö" = 624-1872/frame
- –ó–∞ —Å–µ–∫—É–Ω–¥—É: 31200-93600 "–ª–∏—à–Ω–∏—Ö" t-states!
- –≠—Ç–æ 0.5-1.3 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö frames!

**–†–µ—à–µ–Ω–∏–µ:**
```cpp
const int SLICE_TST = 128;  // –í–º–µ—Å—Ç–æ 224!

int targetAdd = TSTATES_PER_FRAME;  // 69888
while (targetAdd > 0) {
  int budget = min(SLICE_TST, targetAdd);
  int used = Z80Run(regs, budget);
  
  tstateAccumulator += used;  // –ù–∞–∫–∞–ø–ª–∏–≤–∞–µ–º –§–ê–ö–¢–ò–ß–ï–°–ö–ò–ï
  targetAdd -= used;
}
```

**–ü–æ—á–µ–º—É —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- 69888 / 128 = 546 –∫–≤–∞–Ω—Ç–æ–≤
- "–ü–µ—Ä–µ—Ä–∞—Å—Ö–æ–¥" –Ω–∞ –∫–≤–∞–Ω—Ç: 0-10 t-states
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ä–∞—Å—Ö–æ–¥: 546 √ó 10 = 5460/frame
- –≠—Ç–æ –ø—Ä–∏–µ–º–ª–µ–º–æ! (7.8% –≤–º–µ—Å—Ç–æ 300%+)

---

### 4. **Accumulator & INT –≥–µ–Ω–µ—Ä–∞—Ü–∏—è** ‚≠ê

**–ö–æ–Ω—Ç—Ä–∞–∫—Ç:**
```cpp
static int64_t tstateAccumulator = 0;  // –ù–∞–∫–æ–ø–∏—Ç–µ–ª—å

// –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∫–≤–∞–Ω—Ç–∞:
tstateAccumulator += used;

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è INT (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞ loop!):
while (tstateAccumulator >= 69888) {
  if (IFF1 && IM==1) {
    interrupt();  // JP 0x0038, PUSH PC, IFF1=0
  }
  tstateAccumulator -= 69888;  // –í–°–ï–ì–î–ê –≤—ã—á–∏—Ç–∞–µ–º!
  totalFrames++;
}
```

**–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:**

1. **`while` –≤–º–µ—Å—Ç–æ `if`:**  
   –ï—Å–ª–∏ –Ω–∞–∫–æ–ø–∏–ª–æ—Å—å 140000 t-states ‚Üí 2 INT!

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ IFF1:**  
   –ï—Å–ª–∏ IFF1=0 ‚Üí –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –¢–ï–†–Ø–ï–¢–°–Ø (–∫–∞–∫ –Ω–∞ —Ä–µ–∞–ª–µ!)

3. **–í—Å–µ–≥–¥–∞ –≤—ã—á–∏—Ç–∞–µ–º:**  
   –î–∞–∂–µ –µ—Å–ª–∏ IFF1=0, –≤—ã—á–∏—Ç–∞–µ–º frame!

4. **int64_t —Ç–∏–ø:**  
   –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è (max ~9 –∫–≤–∏–Ω—Ç–∏–ª–ª–∏–æ–Ω–æ–≤ t-states)

---

### 5. **HUD Snapshot** (—Å–µ—Ä–µ–¥–∏–Ω–∞ –∫–∞–¥—Ä–∞)

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–ï—Å–ª–∏ –±—Ä–∞—Ç—å PC —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ INT ‚Üí –≤—Å–µ–≥–¥–∞ 0x0038!

**–†–µ—à–µ–Ω–∏–µ:**
```cpp
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (snapshot)
static uint16_t hud_pc = 0;
static uint8_t hud_iff1 = 0;

// –í —Å–µ—Ä–µ–¥–∏–Ω–µ frame (–ø–æ—Å–ª–µ ~35000 t-states):
if (cyclesExecuted >= MIDFRAME_TSTATES && !snapshotTaken) {
  hud_pc = z80Regs->PC.W;
  hud_iff1 = z80Regs->IFF1;
  snapshotTaken = true;
}

// –í main.cpp:
Serial.printf("PC: 0x%04X", spectrum->getHudPC());
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**  
PC –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–∂–∏–≤—ã–µ" –∞–¥—Ä–µ—Å–∞: 0x10B4, 0x0E5C, 0x15E8...

---

## üéØ ZX SPECTRUM 48K TIMING:

### –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã:
```cpp
CPU_FREQ       = 3.5 MHz
TSTATES_LINE   = 224
LINES_FRAME    = 312
TSTATES_FRAME  = 69888  (224 √ó 312)
FRAMES_SECOND  = 50     (PAL)
INT_FREQ       = 50 Hz
```

### Frame —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (PAL):
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Top Border      (64 lines)        ‚îÇ  14336 t-states
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Screen          (192 lines)       ‚îÇ  43008 t-states
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Bottom Border   (56 lines)        ‚îÇ  12544 t-states
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  VBlank          (?)               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
Total: 312 lines = 69888 t-states
INT triggered at start of frame
```

---

## üíæ MEMORY MAP:

```
0x0000 - 0x3FFF  ROM (16KB)       [Read-only]
0x4000 - 0x57FF  VRAM (6KB)       [Screen data]
0x5800 - 0x5AFF  VRAM (768B)      [Attributes]
0x5B00 - 0x5BFF  Printer buffer   [System vars]
0x5C00 - 0x5CBF  System variables
0x5CC0 - 0xFFFF  User RAM (~42KB)
```

### ROM –≤–∞–∂–Ω—ã–µ –∞–¥—Ä–µ—Å–∞:
```
0x0000: F3           ; DI (–Ω–∞—á–∞–ª–æ ROM)
0x0001: AF           ; XOR A
0x0038: F5           ; PUSH AF (IM1 vector)
      : E5           ; PUSH HL
      : 2A 78 5C     ; LD HL,(FRAMES)
      : 23           ; INC HL
      : 22 78 5C     ; LD (FRAMES),HL
      : ...          ; (increment frame counter)
      : F1           ; POP AF
      : E1           ; POP HL
      : FB           ; EI
      : C9           ; RET
```

---

## üîÑ INT HANDLER (IM1):

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ INT:

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ IFF1:**
   ```cpp
   if (!regs->IFF1) return;  // INT –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è!
   ```

2. **PUSH PC:**
   ```cpp
   SP -= 2;
   memory[SP] = PC_lo;
   memory[SP+1] = PC_hi;
   ```

3. **Jump to vector:**
   ```cpp
   if (IM == 1) PC = 0x0038;
   ```

4. **Disable interrupts:**
   ```cpp
   IFF1 = 0;  // –î–æ EI –≤ handler!
   ```

5. **Handler –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è:**
   ```asm
   0x0038: PUSH AF      ; –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä—ã
           PUSH HL
           LD HL,(FRAMES)
           INC HL       ; –£–≤–µ–ª–∏—á–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ –∫–∞–¥—Ä–æ–≤
           LD (FRAMES),HL
           POP HL
           POP AF
           EI           ; –†–∞–∑—Ä–µ—à–∏—Ç—å INT (—Å delay!)
           RET          ; –í–µ—Ä–Ω—É—Ç—å—Å—è (–ø–æ—Å–ª–µ RET: IFF1=1)
   ```

---

## üß™ DEBUGGING:

### –ü–æ–ª–µ–∑–Ω—ã–µ —Ç–æ—á–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:

```cpp
// 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ ROM
ROM[0x0000] –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 0xF3
ROM[0x0001] –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 0xAF

// 2. Z80 state
PC –¥–æ–ª–∂–µ–Ω –º–µ–Ω—è—Ç—å—Å—è (–Ω–µ 0x0000, –Ω–µ 0x0038 –ø–æ—Å—Ç–æ—è–Ω–Ω–æ)
IM –¥–æ–ª–∂–µ–Ω —Å—Ç–∞—Ç—å 1 –ø–æ—Å–ª–µ ~2 —Å–µ–∫—É–Ω–¥
IFF1 –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 1 –º–µ–∂–¥—É INT

// 3. Accumulator
–î–æ–ª–∂–µ–Ω –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è < 1000 –æ–±—ã—á–Ω–æ
–ï—Å–ª–∏ > 100000 ‚Üí –ø—Ä–æ–±–ª–µ–º–∞ —Å —Ü–∏–∫–ª–∞–º–∏!

// 4. INT rate
–î–æ–ª–∂–Ω–æ –±—ã—Ç—å 49-51 INT/s
–ï—Å–ª–∏ < 45 ‚Üí —Å–ª–∏—à–∫–æ–º –º–µ–¥–ª–µ–Ω–Ω–æ
–ï—Å–ª–∏ > 55 ‚Üí —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ
```

---

## ‚ö†Ô∏è COMMON PITFALLS:

### 1. EI –±–µ–∑ delay
```cpp
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:
case EI:
  r_IFF1 = r_IFF2 = 1;  // –°—Ä–∞–∑—É!
  
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
case EI:
  r_ei_pending = 1;  // –û—Ç–ª–æ–∂–µ–Ω–Ω–æ!
```

### 2. IF –≤–º–µ—Å—Ç–æ WHILE
```cpp
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:
if (acc >= 69888) {
  interrupt();
  acc -= 69888;
}

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
while (acc >= 69888) {  // –ú–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ!
  interrupt();
  acc -= 69888;
}
```

### 3. –ë–æ–ª—å—à–∏–µ –∫–≤–∞–Ω—Ç—ã
```cpp
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:
runForCycles(224);  // –ü–µ—Ä–µ—Ä–∞—Å—Ö–æ–¥ 2-6 t-states

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
runForCycles(128);  // –ü–µ—Ä–µ—Ä–∞—Å—Ö–æ–¥ 0-10, –Ω–æ –º–µ–Ω—å—à–µ –∫–≤–∞–Ω—Ç–æ–≤
```

### 4. –ù–µ –≤—ã—á–∏—Ç–∞—Ç—å –ø—Ä–∏ IFF1=0
```cpp
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:
if (IFF1) {
  interrupt();
  acc -= 69888;
}
// –ï—Å–ª–∏ IFF1=0 ‚Üí accumulator —Ä–∞—Å—Ç—ë—Ç –¥–æ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç–∏!

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
if (IFF1) interrupt();
acc -= 69888;  // –í–°–ï–ì–î–ê!
```

---

## üìä PERFORMANCE:

### –ò–∑–º–µ—Ä–µ–Ω–∏—è (ESP32-S3 @ 240 MHz):

```
CPU usage:        ~30-40%
Frame time:       ~12-15ms (target: 20ms)
Heap free:        ~293KB
Z80 instructions: ~3500 MHz —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç (–∏–∑-–∑–∞ overhead)
Actual Z80 freq:  ~3.5 MHz —ç–º—É–ª–∏—Ä—É–µ–º–∞—è
```

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:

1. **–ú–∞–ª—ã–µ –∫–≤–∞–Ω—Ç—ã** ‚Üí –º–µ–Ω—å—à–µ –ø–µ—Ä–µ—Ä–∞—Å—Ö–æ–¥–∞
2. **Static –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ** ‚Üí –Ω–µ —Ä–µ–∞–ª–ª–æ—Ü–∏—Ä—É—é—Ç—Å—è
3. **int64_t accumulator** ‚Üí –∑–∞—â–∏—Ç–∞ –æ—Ç overflow
4. **Callback functions** ‚Üí –≥–∏–±–∫–æ—Å—Ç—å –±–µ–∑ overhead

---

## üéì REFERENCES:

1. **Z80 CPU Manual:**  
   http://www.zilog.com/docs/z80/um0080.pdf

2. **ZX Spectrum Technical Manual:**  
   https://worldofspectrum.org/

3. **ESP32 Rainbow (original):**  
   https://github.com/atomic14/esp32-zxspectrum

4. **Z80 Emulation (Santiago Romero):**  
   http://www.github.com/jsanchezv/z80

---

## üí° FUTURE IMPROVEMENTS:

1. **Display rendering** (ULA emulation)
2. **Keyboard input** (port 0xFE)
3. **Sound** (beeper)
4. **TAP file loading**
5. **Turbo mode** (7 MHz)
6. **128K model**
7. **AY-3-8912 sound** (for 128K)

---

**–ö–æ–Ω–µ—Ü —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.**  
**–î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞ —Å–º. `QUICKSTART.md`**

